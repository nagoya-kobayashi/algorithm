# AGENT.md
# 探索ゲーム（探索アルゴリズム体験教材）— CODEX作業規約（恒常ルール）

## 1. このファイルの目的
本リポジトリで CODEX が開発・拡張作業を行う際の **恒常ルール（守るべき前提・判断基準・更新漏れ防止ルール）** を定義する。  
拡張指示（ユーザーの自然言語）を受けたら、必ず本ファイルを先に読み、ここに従って実装とドキュメント（00〜07）を更新する。

---

## 2. システム概要（前提）
- クライアント：HTML + CSS + JavaScript（ブラウザ実行）
- サーバ：Perl CGI（ログ受信・ランキング返却）
- 目的：探索アルゴリズム（前方探索／改良／二分探索）により **計算量の差** と **事前準備（ソート・インデクス）の意味** を体験させる

---

## 3. ドキュメント（00〜07）それぞれの役割（概要）
この8本は「仕様の単一の真実の源（Single Source of Truth）」として扱う。実装は常に仕様に一致させる。

- 00_目的と全体像.md  
  授業の狙い／利用シーン／全体構成／ログ活用／成功条件／未確定事項
- 01_要件定義.md  
  Must/Should／非機能／制約（学校環境）／ユースケース
- 02_画面・操作仕様.md  
  画面構成／項目定義／操作フロー／遷移／表示ルール
- 03_機能・処理仕様.md  
  機能一覧／処理フロー（正常・異常）／ログ発火点／エラー方針
- 04_ログ設計（イベント・項目・保存）.md  
  収集方針（最小個人情報）／イベント定義／項目定義／保存形式／分析想定
- 05_実装設計（Web＋PerlCGI）.md  
  ディレクトリ／通信仕様（endpoint/params/戻り）／検証・保存／例外・冪等性
- 06_学校環境・セキュリティ・運用.md  
  学校制約／セキュリティ（XSS/CSRF/入力検証）／個人情報／運用手順
- 07_テスト・変更履歴・意思決定.md  
  テスト観点／最低限テストケース／変更履歴／意思決定メモ／整合チェック

---

## 4. 絶対ルール（最優先の不変条件）
### 4.1 個人情報とログ（最重要）
- クライアントから **氏名を送らない**（送信は user_id 等の最小情報のみ）
- サーバ側で user_id →（年・組・番・氏名）に変換して保存する
- ログ閲覧権限は教員に限定される前提（Webからログ直アクセス不可の配置を推奨）

### 4.2 学校環境前提（壊すと授業が止まる）
- 外部依存（外部CDN・外部API）に依存しない
- 原則 **同一オリジン**（CORSを前提にしない）
- 通信失敗してもゲーム本体が止まらない（ランキング失敗でもクリア体験は成立）

### 4.3 UI/操作の一貫性
- 既存プロトタイプ（ラウンド1）のデザイン・操作感を踏襲する
- クリック回数＝探索回数、計測は最初のクリックから、クリアクリックで停止（基本設計を維持）

### 4.4 ドキュメント整合
- 実装変更は必ず 00〜07 に反映する（下記「更新必須判定」に従う）
- 07 には **変更履歴** と **テスト観点** を必ず追記する（例外なし）

---

## 5. 「更新必須」判定条件（更新漏れ防止のための強制ルール）
以下に該当する変更を行った場合、指定された md を **必ず更新** する。

### 5.1 画面（UI）に関わる変更をした場合
該当例：見出し、列追加、ラウンド切替UI、文言変更、ランキングの見せ方、無効化の挙動
- 必須更新：
  - 02_画面・操作仕様.md（項目定義／表示ルール／操作手順）
  - 07_テスト・変更履歴・意思決定.md（テスト観点＋変更履歴）
- 追加で更新の可能性：
  - 01_要件定義.md（Must/Shouldに影響する場合）
  - 00_目的と全体像.md（授業運用・成功条件が変わる場合）

### 5.2 ゲームロジック（処理フロー）に関わる変更をした場合
該当例：探索回数の数え方、タイマー開始条件、クリア条件、二分探索デモの制御、未クリック判定
- 必須更新：
  - 03_機能・処理仕様.md（処理フロー／異常系／ログ発火点）
  - 07（同上）
- 追加で更新の可能性：
  - 02（操作手順・表示ルールに影響する場合）
  - 01（要件のMust/Should変更が発生した場合）

### 5.3 ログ項目・イベント・保存形式を変更した場合
該当例：送信payload追加、ログ列追加、保存形式変更、保存期間・ローテーション変更
- 必須更新：
  - 04_ログ設計（イベント・項目・保存）.md
  - 05_実装設計（Web＋PerlCGI）.md（params/戻り/検証/保存）
  - 06_学校環境・セキュリティ・運用.md（個人情報・運用に影響）
  - 07（同上）
- 強制注意：
  - 個人情報の範囲を広げる変更は禁止（やるなら06で明示し、匿名化方針を必ず定義）

### 5.4 CGIエンドポイント・通信方式を変更した場合
該当例：URL変更、GET/POST変更、Content-Type変更、レスポンスJSON変更
- 必須更新：
  - 05_実装設計（Web＋PerlCGI）.md（endpoint/params/戻り/エラー）
  - 03_機能・処理仕様.md（送信・取得のフロー）
  - 07（同上）

### 5.5 非機能（性能、可用性、保守、データ保持）に影響する変更をした場合
該当例：ランキング計算のやり方、更新間隔、データ量、再送戦略、保存期間
- 必須更新：
  - 01_要件定義.md（非機能、制約）
  - 07（同上）
- 追加で更新の可能性：
  - 04/05（ログ保存や計算に影響する場合）

### 5.6 学校運用・セキュリティに影響する変更をした場合
該当例：アクセス制御、ログ配置、閲覧権限、HTTPS前提化、端末前提の変更
- 必須更新：
  - 06_学校環境・セキュリティ・運用.md
  - 07（同上）
- 追加で更新の可能性：
  - 01（制約・前提）
  - 05（配置・権限・例外方針）

---

## 6. 作業手順（CODEXが毎回やること）
1) AGENT.md と 00〜07 を読む  
2) ユーザー指示から「影響範囲」を特定  
3) 更新対象ファイル（実装＋md）を自動で決定（ユーザーに列挙を求めない）  
4) 既存のデザイン・操作性を維持しながら実装を編集  
5) 仕様（00〜07）を更新必須判定に従って編集  
6) 07 に追記
   - 変更履歴（日時・要点）
   - テスト観点（最低限）
   - 意思決定メモ（迷った点・採用理由・代替案）
7) 最低限の動作確認（手動想定でOK）
   - 起動、クリック、回数、タイマー、クリア、全開示、未クリック青字、クリック無効、ランキング取得（失敗時も画面が止まらない）

---

## 7. 実装の設計原則（拡張しやすさ）
- データ（roster_*.js）とロジック（main_*.js等）を分離する
- 可能ならラウンド差分は「設定オブジェクト」で吸収する
  - 例：target, sortedFlag, indexColumn, demoMode, pollingRule など
- UI文言（タスク文等）は定数として一箇所に集約する
- エラーは握り潰さず「画面に短文で通知」し、授業が止まらない設計にする

---

## 8. 整合チェック（作業の最後に必ず確認）
- 02の表示仕様と実装が一致しているか（列・文言・無効化・青字）
- 03の処理フローと実装が一致しているか（開始・計測・クリア・送信）
- 04のログ項目と、05のCGI受信仕様と、実装のpayloadが一致しているか
- 06の個人情報方針（氏名を送らない等）を破っていないか
- 07に変更履歴・テスト観点が必ず追記されているか（ゼロは不可）

---

## 9. 例外の扱い（質問しない）
ユーザー指示が曖昧でも、作業を止めずに以下で進める。
- 合理的な仮定を置く
- 仮定した内容は 07 の「意思決定メモ」に明記する
- 仕様と実装が破綻しない最小変更で着地する

---

## 10. 禁止事項
- 仕様（00〜07）と実装を矛盾させたまま放置すること
- 07を更新しないこと
- 個人情報をクライアント送信すること（氏名等）
- 外部依存を増やすこと（学校環境で詰まる要因を作らない）
