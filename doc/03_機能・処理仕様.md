# 探索ゲーム（探索アルゴリズム体験教材）— 機能・処理仕様（ラウンド1〜4）

## 機能一覧（正式名称、概要、対象画面、権限）
1. タイトル画面開始・ラウンド選択  
   - 概要：タイトル画面の「はじめる」でクリア記録を確認し、未クリアの最小ラウンドに遷移する  
   - 対象画面：タイトル画面／探索ゲーム画面  
   - 権限：生徒

2. ラウンド開始演出  
   - 概要：ラウンド名・探索方式・タスク文を演出表示し、終了後に探索ゲーム画面へ遷移する  
   - 対象画面：ラウンド開始演出  
   - 権限：生徒

3. ブラウザ戻るボタン無効化  
   - 概要：履歴操作を抑止し、画面状態を維持する  
   - 対象画面：全画面  
   - 権限：生徒

4. ユーザID管理  
   - 概要：アクセスURLの #id= からユーザIDを取得し、ヘッダに表示・送信に使用（未設定／名簿未登録時は操作不可で警告）  
   - 対象画面：タイトル画面／探索ゲーム画面／結果画面  
   - 権限：生徒

5. 名簿データ読込（ラウンド別）  
   - 概要：roster.js が student.csv を読み込み、#id= のユーザ情報からラウンド用名簿を生成  
     - ラウンド1：同一クラス + 正解データ（小林 裕司）を追加 → ランダムシャッフル  
     - ラウンド2：同一学年 + 正解データ（小林 裕司）を追加 → ふりがな昇順ソート＋インデクス（かな行の先頭のみラベル）付与  
     - ラウンド3：同一学年 + 正解データ（御家 雄一）を追加 → ふりがな昇順ソート  
     - ラウンド4：全データ → ふりがな昇順ソート（正解はアクセス中ユーザの行）  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

6. 行クリック開示  
   - 概要：未クリック行クリックでCPUマッチング演出を行い、完了後に行データを表示して探索回数を増やす（クリック済み行は回数を増やさない）  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

7. 探索回数カウント  
   - 概要：未クリック行のクリック回数を探索回数として保持・表示  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

8. クリアタイム計測  
   - 概要：最初のクリックで計測開始、クリアクリックで停止  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

9. クリア判定（ラウンド別ターゲット）  
   - 概要：ラウンド別ターゲットに一致した行がクリックされたらクリア  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

10. クリア時結果送信  
   - 概要：ユーザID・ラウンドNo・探索回数・クリアタイムをサーバに送信  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

11. クリア後全データ開示・未クリック青字  
   - 概要：全行を表示し、未クリック行の文字色を青にする。以後クリック無効  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

12. ランキング取得・定期更新（探索ゲーム画面）  
   - 概要：user_id確定後に同一クラスのベストスコア（user_idごとに最良記録）を全員取得。並び順はタイム→回数。2秒おきに継続更新し、10件以上の時点で次ラウンドのみ活性化（前後ラウンドは非活性のまま）  
   - 対象画面：探索ゲーム画面  
   - 権限：生徒

13. 結果画面ランキング取得・定期更新  
   - 概要：ラウンド1〜4のランキングを1秒おきに取得し表示する  
   - 対象画面：結果画面  
   - 権限：生徒

---

## 各機能の処理フロー（正常／異常）
## 1. タイトル画面開始・ラウンド選択（正常）
1. URLの #id= からユーザIDを取得し、名簿照合を行う
2. 「はじめる」クリックでラウンド1〜4のランキングを取得し、clear_time_msの記録有無でクリア済み判定を行う
3. 未クリアの最小ラウンドを選択（全ラウンドクリア済みの場合は結果画面へ遷移）
4. ラウンド開始演出へ

（異常）
- user_id未設定／未登録：注意表示し開始しない
- ランキング取得失敗：未クリア扱いとして最小ラウンドから開始する

## 2. ラウンド開始演出（正常）
1. 左上からラウンド名を降下表示
2. 中央に探索方式・タスク文を跳ねる演出で表示
3. 右側に画像を出現させる
4. 数秒後にフェードアウトし探索ゲーム画面へ

（異常）
- 演出中の操作は受け付けない

## 6. 行クリック開示（正常）

1. クリック受付（クリア前のみ。ユーザID未設定の場合は警告を表示し処理しない）
   - 名簿に存在しないユーザIDの場合も警告を表示し処理しない
2. クリック済み行の場合は処理を終了（回数を増やさない）
3. 探索回数 +1
4. 計測開始（未開始なら開始時刻を記録）
5. ふりがなの左に cpu.png を表示し、0.3秒ごとに1文字ずつ赤色でマッチング演出
   - 処理中は他行クリックを無効化
6. 演出完了後に「matched/unmatched」アイコンを表示（正解=緑、その他=赤）
7. 対象行データを表に描画（年・組・番・氏名・ふりがな）
8. 当該行を「クリック済み」として記録
9. クリア判定へ

（異常）
- 名簿データが未読込：致命（画面にエラー表示、操作停止）
- クリック対象が不正：無視（想定外）
- ユーザID未設定：ヘッダに注意を出し、クリックを無効化

## 9. クリア判定（正常）
- ラウンド別ターゲット：
  - ラウンド1：追加した正解データ（小林 裕司）の行
  - ラウンド2：追加した正解データ（小林 裕司）の行
  - ラウンド3：追加した正解データ（御家 雄一）の行
  - ラウンド4：アクセス中ユーザ（#id= の名簿行）
一致した場合：
1. クリアフラグON
2. 計測停止（クリア時刻記録）
3. クリア後表示処理へ（マッチング演出完了後に実施）
4. 結果送信へ
5. ランキング取得を開始／継続する

（異常）
- ターゲット未設定：致命（設計ミス）

## 10. クリア時結果送信（正常）
1. 送信payload作成：user_id（URLの #id= で指定された値）, round_no, search_count, clear_time_ms
2. fetch(POST)でPerl CGI（`log_result.pl`）へ送信
3. 応答OKなら「送信完了」表示（任意）

（異常）
- 通信失敗：画面表示は更新せず、一定回数リトライ（推奨）
- 応答がエラー：画面表示は更新せず

## 12. ランキング取得（探索ゲーム画面）（正常）
1. user_id が確定した時点でランキング取得を開始（クリア不要）
2. fetch(GET)でランキングAPI（`get_ranking.pl`）へ（user_idはURLの #id= で指定された値、round_no）
3. ranking配列を表示（全員）
4. 2秒後に再取得（件数に関わらず継続）
5. 件数が10以上になったら次ラウンドボタンのみ活性化（取得は継続）

（異常）
- 通信失敗：表示は更新せず、次回の取得を継続
- ユーザID未設定：取得を開始せず、画面に「#id= を指定してください」と表示

## 13. 結果画面ランキング取得（正常）
1. 結果画面表示時にラウンド1〜4のランキング取得を開始
2. 1秒おきに再取得（件数に関わらず継続）
3. ラウンドごとにランキング配列を表示

（異常）
- 通信失敗：該当ラウンドは更新せず、次回の取得を継続

---

## ログ発火点（どの操作でどのログが出るか）
本教材の必須ログは「クリア時結果送信」のみ（最小構成）。

- クリア時：結果ログ（必須）
（将来案）
- 開始時：開始ログ（任意）
- 各クリック：クリックログ（任意、ただし個人情報・量に注意）

---

## エラーメッセージ方針
- 生徒向けは短く具体的に（例：通信に失敗しました。後で再試行します。）
- 技術詳細は表示しない（教員がコンソールで確認できれば十分）
- 致命エラーは「再読込してください／教員に連絡」を明記

---

## 未確定事項リスト（初版）
- #id=付きURLをどのように配布・管理するか（クラス別URL、個人別URL）
- 送信失敗時の再送仕様（回数／間隔／手動再送ボタン）
- ランキング更新の間隔・負荷調整（継続更新の運用バランス）
